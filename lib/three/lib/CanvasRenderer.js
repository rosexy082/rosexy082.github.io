THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(e,t){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){console.log("THREE.CanvasRenderer",THREE.REVISION),e=e||{};var j,k,D,F,N,O,A,I,G,U,q,J,pe,Ee,de,he,fe,K=this,me=new THREE.Projector,o=void 0!==e.canvas?e.canvas:document.createElement("canvas"),Q=o.width,X=o.height,Y=Math.floor(Q/2),Z=Math.floor(X/2),xe=0,ve=0,ye=Q,Re=X,n=1,$=o.getContext("2d",{alpha:!0===e.alpha}),i=new THREE.Color(0),r=!0===e.alpha?0:1,a=1,s=0,l=null,c=null,p=null,E=null,d=null,t=[],_=(new THREE.RenderableVertex,new THREE.RenderableVertex,new THREE.Color),Te=(new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color),ge=new THREE.Color,ue=new THREE.Color,ee={},te=new THREE.Box2,ie=new THREE.Box2,oe=new THREE.Box2,Se=new THREE.Color,He=new THREE.Color,we=new THREE.Color,Ce=new THREE.Vector3,Me=new THREE.Vector3,ne=new THREE.Vector3,re=new THREE.Matrix3;function be(e,t,i,o){We(t),ze(i),je(o),le(e.getStyle()),$.stroke(),oe.expandByScalar(2*t)}function Le(e){ce(e.getStyle()),$.fill()}function Be(e){var t,i,o,n,r,a,s;return 0===e.version||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture?{canvas:void 0,version:e.version}:!1===(t=e.image).complete?{canvas:void 0,version:0}:(i=e.wrapS===THREE.RepeatWrapping||e.wrapS===THREE.MirroredRepeatWrapping,o=e.wrapT===THREE.RepeatWrapping||e.wrapT===THREE.MirroredRepeatWrapping,a=e.wrapS===THREE.MirroredRepeatWrapping,s=e.wrapT===THREE.MirroredRepeatWrapping,(n=document.createElement("canvas")).width=t.width*(a?2:1),n.height=t.height*(s?2:1),(r=n.getContext("2d")).setTransform(1,0,0,-1,0,t.height),r.drawImage(t,0,0),1==a&&(r.setTransform(-1,0,0,-1,t.width,t.height),r.drawImage(t,-t.width,0)),1==s&&(r.setTransform(1,0,0,1,0,0),r.drawImage(t,0,t.height)),1==a&&1==s&&(r.setTransform(-1,0,0,1,t.width,0),r.drawImage(t,-t.width,t.height)),a="no-repeat",1==i&&1==o?a="repeat":1==i?a="repeat-x":1==o&&(a="repeat-y"),s=$.createPattern(n,a),e.onUpdate&&e.onUpdate(e),{canvas:s,version:e.version})}function Pe(e,t,i,o,n,r,a,s,l,c,p,E,d){var h,f,m=ee[d.id];void 0!==m&&m.version===d.version||(m=Be(d),ee[d.id]=m),void 0===m.canvas?(ce("rgba( 0, 0, 0, 1)"),$.fill()):(ce(m.canvas),m=d.offset.x/d.repeat.x,h=d.offset.y/d.repeat.y,l=(l+m)*(f=d.image.width*d.repeat.x),c=(c+h)*(d=d.image.height*d.repeat.y),p=(p+m)*f,E=(E+h)*d,i-=e,o-=t,n-=e,r-=t,0!=(m=(l-=a=(a+m)*f)*(E-=s=(s+h)*d)-(p-=a)*(c-=s))&&(e=e-(h=(E*i-c*n)*(f=1/m))*a-(d=(l*n-p*i)*f)*s,i=t-(m=(E*o-c*r)*f)*a-(n=(l*r-p*o)*f)*s,$.save(),$.transform(h,m,d,n,e,i),$.fill(),$.restore()))}function Ve(e,t,i){var o=t.x-e.x,n=t.y-e.y,r=o*o+n*n;0!=r&&(n*=i/=Math.sqrt(r),t.x+=o*=i,t.y+=n,e.x-=o,e.y-=n)}function ae(e){a!==e&&($.globalAlpha=e,a=e)}function se(e){s!==e&&(e===THREE.NormalBlending?$.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?$.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending?$.globalCompositeOperation="darker":e===THREE.MultiplyBlending&&($.globalCompositeOperation="multiply"),s=e)}function We(e){p!==e&&($.lineWidth=e,p=e)}function ze(e){E!==e&&($.lineCap=e,E=e)}function je(e){d!==e&&($.lineJoin=e,d=e)}function le(e){l!==e&&($.strokeStyle=e,l=e)}function ce(e){c!==e&&($.fillStyle=e,c=e)}function ke(e){t.length!==e.length&&($.setLineDash(e),t=e)}void 0===$.setLineDash&&($.setLineDash=function(){}),this.domElement=o,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return $},this.getContextAttributes=function(){return $.getContextAttributes()},this.getPixelRatio=function(){return n},this.setPixelRatio=function(e){void 0!==e&&(n=e)},this.setSize=function(e,t,i){Q=e*n,X=t*n,o.width=Q,o.height=X,Y=Math.floor(Q/2),Z=Math.floor(X/2),!1!==i&&(o.style.width=e+"px",o.style.height=t+"px"),te.min.set(-Y,-Z),te.max.set(Y,Z),ie.min.set(-Y,-Z),ie.max.set(Y,Z),a=1,s=0,d=E=p=c=l=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,o){xe=e*n,ve=t*n,ye=i*n,Re=o*n},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(e,t){i.set(e),r=void 0!==t?t:1,ie.min.set(-Y,-Z),ie.max.set(Y,Z)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return i},this.getClearAlpha=function(){return r},this.getMaxAnisotropy=function(){return 0},this.clear=function(){!1===ie.isEmpty()&&(ie.intersect(te),ie.expandByScalar(2),ie.min.x=ie.min.x+Y,ie.min.y=-ie.min.y+Z,ie.max.x=ie.max.x+Y,ie.max.y=-ie.max.y+Z,r<1&&$.clearRect(0|ie.min.x,0|ie.max.y,ie.max.x-ie.min.x|0,ie.min.y-ie.max.y|0),0<r&&(se(THREE.NormalBlending),ae(1),ce("rgba("+Math.floor(255*i.r)+","+Math.floor(255*i.g)+","+Math.floor(255*i.b)+","+r+")"),$.fillRect(0|ie.min.x,0|ie.max.y,ie.max.x-ie.min.x|0,ie.min.y-ie.max.y|0)),ie.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,t){if(t instanceof THREE.Camera==0)console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");else{var i=e.background;i&&i.isColor?(ce("rgb("+Math.floor(255*i.r)+","+Math.floor(255*i.g)+","+Math.floor(255*i.b)+")"),$.fillRect(0,0,Q,X)):!0===this.autoClear&&this.clear(),K.info.render.vertices=0,K.info.render.faces=0,$.setTransform(ye/Q,0,0,-Re/X,xe,X-ve),$.translate(Y,Z),j=me.projectScene(e,t,this.sortObjects,this.sortElements),k=j.elements,D=j.lights,re.getNormalMatrix(t.matrixWorldInverse),Se.setRGB(0,0,0),He.setRGB(0,0,0),we.setRGB(0,0,0);for(var o=0,n=D.length;o<n;o++){var r=D[o],a=r.color;r instanceof THREE.AmbientLight?Se.add(a):r instanceof THREE.DirectionalLight?He.add(a):r instanceof THREE.PointLight&&we.add(a)}for(var s=0,l=k.length;s<l;s++){var c=k[s],p=c.material;if(void 0!==p&&0!==p.opacity){if(oe.makeEmpty(),c instanceof THREE.RenderableSprite){(F=c).x*=Y,F.y*=Z;var E=T=R=y=v=x=m=f=h=d=void 0,d=F,h=c,f=p,m=(ae(f.opacity),se(f.blending),h.scale.x*Y),h=h.scale.y*Z,x=.5*Math.sqrt(m*m+h*h);oe.min.set(d.x-x,d.y-x),oe.max.set(d.x+x,d.y+x),f instanceof THREE.SpriteMaterial?null!==(x=f.map)?(void 0!==(v=ee[x.id])&&v.version===x.version||(v=Be(x),ee[x.id]=v),void 0!==v.canvas&&(ce(v.canvas),y=(v=x.image).width*x.offset.x,R=v.height*x.offset.y,T=v.width*x.repeat.x,v=v.height*x.repeat.y,x=m/T,E=h/v,$.save(),$.translate(d.x,d.y),0!==f.rotation&&$.rotate(f.rotation),$.translate(-m/2,-h/2),$.scale(x,E),$.translate(-y,-R),$.fillRect(y,R,T,v),$.restore())):(ce(f.color.getStyle()),$.save(),$.translate(d.x,d.y),0!==f.rotation&&$.rotate(f.rotation),$.scale(m,-h),$.fillRect(-.5,-.5,1,1),$.restore()):f instanceof THREE.SpriteCanvasMaterial&&(le(f.color.getStyle()),ce(f.color.getStyle()),$.save(),$.translate(d.x,d.y),0!==f.rotation&&$.rotate(f.rotation),$.scale(m,h),f.program($),$.restore())}else if(c instanceof THREE.RenderableLine){if(F=c.v1,N=c.v2,F.positionScreen.x*=Y,F.positionScreen.y*=Z,N.positionScreen.x*=Y,N.positionScreen.y*=Z,oe.setFromPoints([F.positionScreen,N.positionScreen]),!0===te.intersectsBox(oe)){var v=T=R=y=E=x=void 0,x=F,E=N,y=c,R=p;if(ae(R.opacity),se(R.blending),$.beginPath(),$.moveTo(x.positionScreen.x,x.positionScreen.y),$.lineTo(E.positionScreen.x,E.positionScreen.y),R instanceof THREE.LineBasicMaterial){if(We(R.linewidth),ze(R.linecap),je(R.linejoin),R.vertexColors!==THREE.VertexColors)le(R.color.getStyle());else{var T=y.vertexColors[0].getStyle();if(T===(y=y.vertexColors[1].getStyle()))le(T);else{try{var v=$.createLinearGradient(x.positionScreen.x,x.positionScreen.y,E.positionScreen.x,E.positionScreen.y);v.addColorStop(0,T),v.addColorStop(1,y)}catch(e){v=T}le(v)}}$.stroke(),oe.expandByScalar(2*R.linewidth)}else R instanceof THREE.LineDashedMaterial&&(We(R.linewidth),ze(R.linecap),je(R.linejoin),le(R.color.getStyle()),ke([R.dashSize,R.gapSize]),$.stroke(),oe.expandByScalar(2*R.linewidth),ke([]))}}else if(c instanceof THREE.RenderableFace){if(F=c.v1,N=c.v2,O=c.v3,F.positionScreen.z<-1||1<F.positionScreen.z)continue;if(N.positionScreen.z<-1||1<N.positionScreen.z)continue;if(O.positionScreen.z<-1||1<O.positionScreen.z)continue;if(F.positionScreen.x*=Y,F.positionScreen.y*=Z,N.positionScreen.x*=Y,N.positionScreen.y*=Z,O.positionScreen.x*=Y,O.positionScreen.y*=Z,0<p.overdraw&&(Ve(F.positionScreen,N.positionScreen,p.overdraw),Ve(N.positionScreen,O.positionScreen,p.overdraw),Ve(O.positionScreen,F.positionScreen,p.overdraw)),oe.setFromPoints([F.positionScreen,N.positionScreen,O.positionScreen]),!0===te.intersectsBox(oe)){d=F,m=N,h=O,f=0,K.info.render.vertices+=3,K.info.render.faces++,ae(p.opacity),se(p.blending),O=d.positionScreen.x,A=d.positionScreen.y,I=m.positionScreen.x,G=m.positionScreen.y,U=h.positionScreen.x,q=h.positionScreen.y;var g=O,u=A,S=I,H=G,w=U,C=q;if($.beginPath(),$.moveTo(g,u),$.lineTo(S,H),$.lineTo(w,C),$.closePath(),(p instanceof THREE.MeshLambertMaterial||p instanceof THREE.MeshPhongMaterial)&&null===p.map){Te.copy(p.color),ge.copy(p.emissive),p.vertexColors===THREE.FaceColors&&Te.multiply(c.color),_.copy(Se),Me.copy(d.positionWorld).add(m.positionWorld).add(h.positionWorld).divideScalar(3);for(var M=void 0,b=void 0,L=void 0,B=void 0,P=void 0,V=void 0,M=Me,b=c.normalModel,L=_,B=0,W=D.length;B<W;B++){var P,V,z=D[B];ue.copy(z.color),z instanceof THREE.DirectionalLight?(P=Ce.setFromMatrixPosition(z.matrixWorld).normalize(),(V=b.dot(P))<=0||(V*=z.intensity,L.add(ue.multiplyScalar(V)))):z instanceof THREE.PointLight&&(P=Ce.setFromMatrixPosition(z.matrixWorld),(V=b.dot(Ce.subVectors(P,M).normalize()))<=0||0!=(V*=0==z.distance?1:1-Math.min(M.distanceTo(P)/z.distance,1))&&(V*=z.intensity,L.add(ue.multiplyScalar(V))))}_.multiply(Te).add(ge),!0===p.wireframe?be(_,p.wireframeLinewidth,p.wireframeLinecap,p.wireframeLinejoin):Le(_)}else p instanceof THREE.MeshBasicMaterial||p instanceof THREE.MeshLambertMaterial||p instanceof THREE.MeshPhongMaterial?null!==p.map?p.map.mapping===THREE.UVMapping&&(J=c.uvs,Pe(O,A,I,G,U,q,J[f].x,J[f].y,J[1].x,J[1].y,J[2].x,J[2].y,p.map)):null!==p.envMap?p.envMap.mapping===THREE.SphericalReflectionMapping&&(ne.copy(c.vertexNormalsModel[f]).applyMatrix3(re),J=.5*ne.x+.5,pe=.5*ne.y+.5,ne.copy(c.vertexNormalsModel[1]).applyMatrix3(re),Ee=.5*ne.x+.5,de=.5*ne.y+.5,ne.copy(c.vertexNormalsModel[2]).applyMatrix3(re),he=.5*ne.x+.5,fe=.5*ne.y+.5,Pe(O,A,I,G,U,q,J,pe,Ee,de,he,fe,p.envMap)):(_.copy(p.color),p.vertexColors===THREE.FaceColors&&_.multiply(c.color),!0===p.wireframe?be(_,p.wireframeLinewidth,p.wireframeLinecap,p.wireframeLinejoin):Le(_)):(p instanceof THREE.MeshNormalMaterial?(ne.copy(c.normalModel).applyMatrix3(re),_.setRGB(ne.x,ne.y,ne.z).multiplyScalar(.5).addScalar(.5)):_.setRGB(1,1,1),!0===p.wireframe?be(_,p.wireframeLinewidth,p.wireframeLinecap,p.wireframeLinejoin):Le(_))}}ie.union(oe)}}$.setTransform(1,0,0,1,0,0)}}};